<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Internet of Things - Group 1</title>
    <style>
        .bar {
            width: 30px;
            background-color: #3b82f6;
        }

        .chart-container {
            width: 100%;
            overflow-x: auto;
        }

        .chart-wrapper {
            min-width: 600px;
            /* Minimum width to ensure the chart is scrollable */
        }
    </style>
</head>

<body class="container mx-auto mt-8">
    <nav>
        <h1 class="text-xl font-bold text-center">Internet of Things - Group 1</h1>
    </nav>
    <main class="mt-8">
        <div class="flex items-center justify-center gap-4">
            <h1 class="text-lg font-bold text-green-500">Control LED</h1>
            <form method="post" action="/led_control">
                <div>
                    <button class="bg-green-500 px-8 py-2 rounded-md text-white text-center" name="action" type="submit"
                        value="On">Turn On</button>
                    <button class="bg-red-500 px-8 py-2 rounded-md text-white text-center" name="action" type="submit"
                        value="Off">Turn Off</button>
                </div>
            </form>
        </div>

        <div class="mt-8">
            <div class="container mx-auto">
                <div class="container mx-auto p-4">
                    <h1 class="text-2xl font-bold mb-4 text-center">Temperature Chart</h1>
                    <div class="chart-container grid grid-cols-1 md:grid-cols-12 gap-4">
                        <div class="chart-wrapper col-span-8 p-4">
                            <canvas id="myChart" class="bg-white p-4 rounded-lg shadow-lg"></canvas>
                        </div>
                        <div class="data-wrapper col-span-4 p-4  ">
                            <div id="sensor-data" class="text-left mt-4 text-xl font-bold leading-tight "></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            fetch('/led_control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=Off',
            })
                .then(response => response.text())
                .then(data => console.log('Đèn tắt khi khởi động:', data))
                .catch(error => console.error('Lỗi khi tắt đèn:', error));
            //socket data
            var socket = io();
            socket.on('connect', function () {
                console.log('Connected to Flask app');
            });
            let lastUpdateTime = 0;
            socket.on('sensor_data', function (data) {
                const currentTime = Date.now();
                if (currentTime - lastUpdateTime >= 7000) {
                    const now = new Date();
                    const formattedTime = now.toLocaleTimeString();
                    console.log('Data received: ', data);
                    document.getElementById('sensor-data').innerHTML = 'Time: ' + `${formattedTime} <br>` + 'Temperature: ' + data.temperature + '°C' + `<br>` + 'Humidity: ' + data.humidity + '%';
                    updateChart(data.temperature);
                    lastUpdateTime = currentTime;
                }
            });

            socket.on('disconnect', function () {
                console.log('Disconnected from Flask app');
            });

            const ctx = document.getElementById("myChart").getContext("2d");
            const myChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: [],
                    datasets: [{
                        label: "Temperature",
                        data: [],
                        borderColor: "rgba(75, 192, 192, 1)",
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1,
                    }],
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 10,
                            },
                        },
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: "top",
                            labels: {
                                color: "#333",
                                font: {
                                    size: 14,
                                },
                            },
                        },
                    },
                },
            });

            function updateChart(temperature) {
                const time = new Date().toLocaleTimeString();

                if (myChart.data.labels.length >= 10) {
                    myChart.data.labels.shift(); // Remove the first (oldest) label
                    myChart.data.datasets[0].data.shift(); // Remove the first (oldest) data point
                }

                myChart.data.labels.push(time);
                myChart.data.datasets[0].data.push(temperature);
                myChart.update();

                if (temperature > 25) {
                    fetch('/led_control', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: 'action=On',
                    })
                        .then(response => response.text())
                        .then(data => {
                            console.log('Đèn bật thành công:', data);
                            setTimeout(() => {
                                ledOn = false;
                                fetch('/led_control', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/x-www-form-urlencoded',
                                    },
                                    body: 'action=Off',
                                })
                                    .then(response => response.text())
                                    .then(data => console.log('Đèn tắt thành công:', data));
                            }, 5000);
                        })
                        .catch(error => console.error('Lỗi khi bật đèn:', error));
                }
            }
        </script>
    </main>
    <footer class="mt-8"></footer>
</body>

</html>